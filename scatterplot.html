<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://unpkg.com/d3fc"></script>
    <title>Embeddings Scatterplot</title>
    <link href='https://fonts.googleapis.com/css?family=Inria+Serif' rel='stylesheet'>

</head>
<style> 
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; 
        font-family: 'Inria Serif', sans-serif;
        background-color: #f9f9f9;
        font-size: 14px;
        color: #002E63;
    }
    #my_scatter {
        width: 60%;
        height: 85%;
    }
    .tooltip {	
        position: absolute;			
        text-align: left;			
        width: 250px;					
        height: auto;					
        padding: 10px;				
        font: 12px 'Inria Serif', sans-serif;		
        background: white;	
        border: 1px solid #ccc;		
        border-radius: 8px;			
        pointer-events: none;			
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        opacity: 0;
        color: #002E63;
        z-index: 9999;
    }
    .card {
        padding: 0px;
        min-height:0;
        font-family: 'Inria Serif';
        border-radius: 15px;
    }
    .scatter_container {
        display: flex;
        height: 100vh;
        width: 100vw;
    }
    #panel {
        width: 40%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        box-sizing: border-box;
    }
    #color-mode-select {
        font-family: 'Inria Serif';
        font-size: 14px;
        cursor: pointer;
    }
    .inactive-highlight {
        text-decoration: line-through;
        opacity: 0.5;
    }
    #options {
        display: flex;
        flex-direction: row;
        gap: 120px;
    }
    #kde-control a {
        font-family: 'Inria Serif';
        cursor: pointer;
    }
    #kde-button:hover {
        scale: 1.1;
    }
    #scatterplot-button:hover {
        scale: 1.1;
        background-color: #d6d6d6;
        transition: background-color 0.3s ease-in-out;
    }
    #about-button:hover {
        scale: 1.1;
        background-color: #d6d6d6;
        transition: background-color 0.3s ease-in-out;
    }
    #kdeplot-button:hover {
        scale: 1.1;
        background-color: #d6d6d6;
        transition: background-color 0.3s ease-in-out;
    }
    #header-container {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 15px;
    }
    #outer-header-container {
        display: flex;
        justify-content: space-between;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        margin-right: 20px;
    }
    #header-main-content {
        display: flex;
        justify-content: space-between; 
        align-items: center;
        width: 100%;
    }

    .header-line {
        height: 1px;             
        background-color: #002E63; 
        width: 95%;             
        margin-top: -7px;       
        margin-left: 100px;
        margin-right: 20px;
    }
    #buttons {
        display: flex;
        gap: 40px;
    }
    #color-mode-control {
        font-size: 16px;
    }
    #color-mode-select {
        font-size: 16px;
        color: #002E63;
    }
    #checkboxes {
        font-size: 16px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        margin-right: 40px;
        user-select: none;
    }
    .checkbox_group {
        display: flex;
        align-items: center;
    }
    .disabled-text {
        text-decoration: line-through;
        color: #999; 
        opacity: 0.6;
    }
    .toggle-label {
        transition: all 0.3s ease;
        color: #002E63; 
        font-weight: bold;
        cursor: pointer !important; 
        display: inline-block;
        padding: 8px 12px;
    }
    .inactive-text {
        text-decoration: line-through;
        color: #B0B0B0; 
        opacity: 0.6;
    }
    .toggle-label:hover {
        opacity: 0.7;
        cursor: pointer;
    }

</style>
<body>
    <div id = outer-header-container>
        <div id = "header-main-content">
            <div id = 'header-container'>
                <div id = "logo">
                    <img src="/images/cdh.png" alt="CDH Logo" width="70px" height="80px">
                </div>
                <div class = "header">
                    <h1>uva research insights scatterplot</h1>
                </div>
            </div>
            <div id = 'buttons'>
                <div id = 'kdeplot-button'>
                    <a href = "kdeplot.html" style="text-decoration: none; color: #002E63; font-size: 18px;">
                        <p>density plot</p>
                    </a>
                </div>
                <div id = 'scatterplot-button'>
                    <a href = "scatterplot.html" style="text-decoration: none; color: #002E63; font-size: 18px;">
                        <p>scatterplot</p>
                    </a>
                </div>
                <div id = 'about-button'>
                    <a href = "about.html" style="text-decoration: none; color: #002E63; font-size: 18px">
                        <p>about</p>
                    </a>
                </div>
            </div>
        </div>
        <div class="header-line"></div>
    </div>
    <div class = "scatter_container">
        <div id="my_scatter"></div>
        <div id = "panel">
            <div id = "controls" class = "card">
                <div id = "checkboxes">
                    <div class = "checkbox_group">
                        <input type="checkbox" id="papers" checked style="display: none;">
                        <label for="papers" class="toggle-label"> papers</label>
                    </div>
                    <div class = "checkbox_group">
                        <input type="checkbox" id="proposals" checked style="display: none;">
                        <label for="proposals" class="toggle-label"> proposals</label>
                    </div> 
                    <div class = "checkbox_group">
                        <input type="checkbox" id="authors" checked style="display: none;">
                        <label for="authors" class="toggle-label"> authors</label>
                    </div>
                </div>
                <br>
                <br>
                <div id = "options">
                    <div id = "color-mode-control">
                        <label for="color-mode-select">color mode:</label>
                        <select id="color-mode-select">
                            <option value = "research category" selected>research category</option>
                            <option value="direct sponsor">direct sponsor</option>
                            <option value="proposal status">proposal status</option>
                            <option value="amount awarded">amount awarded</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id = "legend" class = "card">
                <h2>legend</h2>
            </div>
            <div id = "info" class = "card">
                <h2>information</h2>
                <p>click on a point in the scatterplot to see more information about the corresponding proposal.</p>
                <p>use mouse scroll to zoom in and out. click and drag to pan.</p>
                <p>hover over a point to see the proposal title, pi, and direct sponsor category.</p>
            </div>
            
        </div>
    </div>

    <script type = module>

        import { updateLegend } from './updateLegend.js';

        d3.csv("paper_proposal_updated.csv").then(function(data) {
            
            data.forEach(d => {
                d.umap_x = +d.umap_x;
                d.umap_y = +d.umap_y;
                d.Type = d.Type;
                d.proposal_status = d['Proposal Status'] || 'NA';
                d.award_amount = +d['award_amount'] || 0; 
                const prime_cat = d['Proposal Prime Sponsor Category'];
                const direct_cat = d['Proposal Direct Sponsor Category'];
                
                const prime = d['Proposal Prime Sponsor'];
                const direct = d['Proposal Direct Sponsor'];

                if (prime && prime.trim() !== "") {
                    d.mixed_sponsors_cat = prime_cat;
                    d.mixed_sponsors = prime;
                } 
                else if (direct && direct.trim() !== "") {
                    d.mixed_sponsors_cat = direct_cat;
                    d.mixed_sponsors = direct;
                } 
                else {
                    d.mixed_sponsors_cat = 'N/A';
                    d.mixed_sponsors = 'N/A';
                }
            });
            const categoryCounts = d3.rollup(
                data, 
                v => v.length, 
                d => d.mixed_sponsors_cat || "Missing/Null"
            );

            console.log("--- Mixed Sponsor Category Counts ---");
            console.table(Array.from(categoryCounts));

            const quadtree = d3.quadtree()
                .x(d => d.umap_x)
                .y(d => d.umap_y)
                .addAll(data);

            const getSponsorCategory = (d) => {
                if (!d['mixed_sponsors_cat']) {
                    return 'missing';
                }
                const originalCategory = d['mixed_sponsors_cat'].toLowerCase();

                //wanting fed gov, non profit, industry, foreign sponsor, virginia state sponsor, other
                
                const foreignCategories = [
                    'foreign government',
                    'foreign foundation',
                    'foreign higher education institutions',
                    'foreign industry'
                ];
                const virginiaCategories = [
                    'virginia state higher education institutions',
                    'virginia state agencies'
                ];
                const otherCategories = [
                    'foundation',
                    'local government',
                    'other state governments',
                    'upg',
                    'mc',
                    'division',
                    'institution',
                    'u.s. higher education institutions'
                ];

                if (foreignCategories.includes(originalCategory)) {
                    return 'foreign sponsor';
                }
                else if (virginiaCategories.includes(originalCategory)) {
                    return 'virginia state sponsor';
                }
                else if (otherCategories.includes(originalCategory)) {
                    return 'other';
                }
                
                return originalCategory;    

            };

            const getAwardedStatus = (d) => {
                const originalStatus = d['Proposal Status'].toLowerCase();
                if (originalStatus.includes('awarded')) {
                    return 'awarded';
                } else if (originalStatus.includes('not funded')) {
                    return 'not funded';
                } else {
                    return 'other';
                }
            }

            const min_x = d3.min(data, d => d.umap_x);
            const max_x = d3.max(data, d => d.umap_x);

            const min_y = d3.min(data, d => d.umap_y);
            const max_y = d3.max(data, d => d.umap_y);

            const x = d3.scaleLinear().domain([min_x, max_x]).nice();
            const y = d3.scaleLinear().domain([min_y, max_y]).nice();

            let showPapers = true;
            let showProposals = true;
            let highlightData = []; 
            let colorMode = 'research category';
            let highlightedCategories = [];

            const tooltip = d3.select("body").append("div").attr("class", "tooltip");

            const colorScale = d3.scaleOrdinal()
                .domain([0, 1]) 
                .range(["#1f77b4", "#ff7f0e"]);

            const categoryColorScale = d3.scaleOrdinal(d3.schemeCategory10);

            const statusColorScale = d3.scaleOrdinal()
                .domain(['awarded', 'not funded', 'other'])
                .range(['#1A99E6', '#D67229', '#708090']);

            const amountExtent = d3.extent(data, d => +d['award_amount']);
            const amountColorScale = d3.scaleSequentialLog(d3.interpolateGnBu)
                .domain([1, amountExtent[1]]);

            const fillColor = fc.webglFillColor();

            const toggleCategoryHighlight = (category) => {
                const index = highlightedCategories.indexOf(category);
                
                if (index === -1) {
                    highlightedCategories.push(category);
                } else {
                    highlightedCategories.splice(index, 1);
                }

                updateChart(data);
                updateLegend(data, colorMode, getSponsorCategory, getAwardedStatus, colorScale, categoryColorScale, statusColorScale, amountColorScale, amountExtent, highlightedCategories, toggleCategoryHighlight);
                render();
            };


            const updateChart = (displayData) => {
                if (colorMode === "direct sponsor" || colorMode === "proposal status" || colorMode === "amount awarded") {
                    showPapers = false; 

                    d3.select("label[for='papers']")
                        .classed("disabled-text", true)
                        .classed("inactive-text", false);
                } else {
                    d3.select("label[for='papers']")
                        .classed("disabled-text", false)
                        .classed("inactive-text", !showPapers);     
                }
                fillColor.value(d => {
                    if (colorMode === 'research category') {
                        const isProposal = d.Type === 'proposal' ? 1 : 0; 
                        const color = d3.color(colorScale(isProposal));
                        return [color.r / 255, color.g / 255, color.b / 255, 0.8]; 
                    }
                    else if (colorMode === 'direct sponsor') {
                        const category = getSponsorCategory(d);
                        const color = d3.color(categoryColorScale(category));
                        return [color.r / 255, color.g / 255, color.b / 255, 0.94]; 
                    }
                    else if (colorMode === 'proposal status') {
                        const status = getAwardedStatus(d);
                        const color = d3.color(statusColorScale(status));
                        return [color.r / 255, color.g / 255, color.b / 255, 1.0];
                    }
                    else if (colorMode === 'amount awarded') {
                        const amount = +d['award_amount'];
                        if (amount <= 0) {
                            return [0.39, 0.39, 0.39, 0.6]; 
                        }
                        const logAmount = Math.log10(+d['HURON Authorized Amount']); 
                        const color = d3.color(amountColorScale(amount));
                        return [color.r / 255, color.g / 255, color.b / 255, 1.0];
                    }                   
                })  
            }

            const scatter = fc.seriesWebglPoint()
                    .type(d3.symbolCircle)
                    .size(50)
                    .xScale(x)
                    .yScale(y)
                    .crossValue(d => d.umap_x)
                    .mainValue(d => d.umap_y)
                    .decorate(program => {
                        fillColor(program);
                        const context = program.context();
                        context.enable(context.BLEND);
                        context.blendFunc(context.SRC_ALPHA, context.ONE_MINUS_SRC_ALPHA);
                    });

            const highlightSeries = fc.seriesSvgPoint()
                .type(d3.symbolCircle)
                .size(40) 
                .xScale(x)
                .yScale(y)
                .crossValue(d => d.umap_x)
                .mainValue(d => d.umap_y)
                .decorate(selection => {
                    selection.select('path')
                        .style('fill', 'none')
                        .style('stroke', 'black')
                        .style('stroke-width', 0.6);
                });

            
            const highlightMulti = fc.seriesSvgMulti()
                .series([highlightSeries])
                .mapping((data, index, series) => highlightData);


            const chart = fc
                .chartCartesian(x, y)
                .webglPlotArea(scatter)       
                .svgPlotArea(highlightMulti) 
                .xTickFormat(() => "")
                .yTickFormat(() => "");

            const render = () => {
                let displayData = data;

                if (highlightedCategories.length > 0) {
                    if (colorMode === 'direct sponsor') {
                        displayData = displayData.filter(d => highlightedCategories.includes(getSponsorCategory(d)));
                    }
                    else if (colorMode === 'proposal status') {
                        displayData = displayData.filter(d => highlightedCategories.includes(getAwardedStatus(d)));
                    }
                }

                displayData = displayData.filter(d => {
                    const isProposal = d.Type === 'proposal' ? 1 : 0;
                    if (isProposal && !showProposals) return false;
                    if (!isProposal && !showPapers) return false;
                    return true;
                });

                fillColor.data(displayData);  
 
                updateChart(displayData);   

                d3.select('#my_scatter')
                    .datum(displayData)
                    .call(chart);
            };

            function attachListeners() {
                const plotArea = d3.select('#my_scatter d3fc-svg.plot-area');
                plotArea.style('pointer-events', 'all');

                plotArea.on('mousemove', (event) => {
                    const [mouseX, mouseY] = d3.pointer(event);
                    const xVal = x.invert(mouseX);
                    const yVal = y.invert(mouseY);

                    const closest = quadtree.find(xVal, yVal, 1);

                    let isVisible = false;
                    if (closest) {
                        const isProposal = closest.Type === 'proposal' ? 1 : 0;
                        if ((isProposal && showProposals) || (!isProposal && showPapers)) {
                            isVisible = true;
                        }
                    }

                    if (closest && isVisible) {
                        highlightData = [closest]; 
                        d3.select("#my_scatter").style("cursor", "pointer");
                        tooltip.style("opacity", 0.9);
                        tooltip.html(
                            `<strong>title</strong>: ${closest.Title} <br> 
                            <strong>pi</strong>: ${closest['Proposal PI']} <br>
                            <strong>subfield</strong>: ${closest['subfield_name']}

                        `)
                            
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 20) + "px");
                    } else {
                        highlightData = []; 
                        tooltip.style("opacity", 0);

                        d3.select('#my_scatter').style("cursor", "default");
                    }

                    render();
                });

                plotArea.on('click', () => {
                    if (highlightData.length > 0) {
                        const d = highlightData[0];
                        d3.select("#info").html(`
                            <h2>information</h2>
                            <p><strong>title:</strong> ${d.Title}</p> 
                            <p><strong>pi:</strong> ${d['Proposal PI']}</p>
                            <p><strong>direct sponsor category:</strong> ${d['mixed_sponsors']}</p>
                            <p><strong>subfield</strong>: ${d['subfield_name']}</p>
                            <p><strong>amount awarded:</strong> $${d['award_amount']}</p>
                        `);
                    }
                });
                
                plotArea.on('mouseleave', () => {
                    highlightData = [];
                    tooltip.style("opacity", 0);
                    render();
                });
            }

            d3.selectAll(".toggle-label").on("mouseenter", function() {
                console.log("Hovering over:", this);
                // Only show pointer if not disabled
                if (d3.select(this).classed("disabled-text")) {
                    d3.select(this).style("cursor", "not-allowed");
                } else {
                    d3.select(this).style("cursor", "pointer");
                }
            });

            d3.select("label[for='papers']").on("click", function() {
                if (colorMode !== 'research category') return;
                showPapers = !showPapers;
                d3.select(this).classed("inactive-text", !showPapers);
    
                d3.select("#papers").property("checked", showPapers);
    
                updateChart(data);
                render();
            });

            d3.select("label[for='proposals']").on("click", function() {
                showProposals = !showProposals;

                d3.select(this).classed("inactive-text", !showProposals);
    
                d3.select("#proposals").property("checked", showProposals);
                updateChart(data);
                render();
            });

            d3.select('#color-mode-select').on('change', (event) => {
                colorMode = event.target.value;
                console.log("Color mode changed to:", colorMode);

                highlightedCategories = [];

                updateChart(data);
                updateLegend(data, colorMode, getSponsorCategory, getAwardedStatus, colorScale, categoryColorScale, statusColorScale, amountColorScale, amountExtent, highlightedCategories, toggleCategoryHighlight);
                render();
            });

            const zoom = fc.zoom().on('zoom', render);
            d3.select('#my_scatter').call(zoom, x, y);
            
            updateChart(data);
            updateLegend(data, colorMode, getSponsorCategory, getAwardedStatus, colorScale, categoryColorScale, statusColorScale, amountColorScale, amountExtent, highlightedCategories, toggleCategoryHighlight);
            render();

            attachListeners();
});
        
    
    </script>

</body>