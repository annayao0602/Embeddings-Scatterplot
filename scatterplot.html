<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<html>

<head>
	<script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3fc"></script>
    <title>Embeddings Scatterplot</title>
    <link href='https://fonts.googleapis.com/css?family=Jura' rel='stylesheet'>

</head>
<style> 
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; 
        font-family: 'Jura', sans-serif;
        background-color: #f9f9f9;
        font-size: 14px;
    }
    #my_scatter {
        width: 60%;
        height: 100%;
    }
    .tooltip {	
        position: absolute;			
        text-align: left;			
        width: 250px;					
        height: auto;					
        padding: 10px;				
        font: 12px 'Jura', sans-serif;		
        background: white;	
        border: 1px solid #ccc;		
        border-radius: 8px;			
        pointer-events: none;			
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        opacity: 0;
    }
    .card {
        background-color: #FFFFFF;
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2), 0 4px 10px 0 rgba(0, 0, 0, 0.19);
        padding: 10px;
        min-height:0;
        font-family: Jura;
        border-radius: 15px;
    }
    .scatter_container {
        display: flex;
        height: 100vh;
        width: 100vw;
    }
    #panel {
        width: 40%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        box-sizing: border-box;
    }
    #color-mode-select {
        font-family: Jura;
    }
    .inactive-highlight {
        text-decoration: line-through;
        opacity: 0.5;
    }

</style>
<body>
    <div class = "scatter_container">
        <div id="my_scatter"></div>
        <div id = "panel">
            <div id = "controls" class = "card">
                <h1>Controls</h1>
                <label for="color-mode-select">Color Mode:</label>
                <select id="color-mode-select">
                    <option value="direct sponsor" selected>Direct Sponsor</option>
                    <option value="awarded">Awarded or Not</option>
                    <option value="amount">Amount Awarded</option>
                </select>
                <label for="kde-toggle" style="margin-top: 10px; display: block;">
                    <input type="checkbox" id="kde-toggle">Show Density Heatmap (KDE)
                </label>"
            </div>
            <div id = "legend" class = "card">
                <h1>Legend</h1>
            </div>
            <div id = "info" class = "card">
                <h1>Information</h1>
                <p>Click on a point in the scatterplot to see more information about the corresponding proposal.</p>
                <p>Use mouse scroll to zoom in and out. Click and drag to pan.</p>
                <p>Hover over a point to see the proposal title, PI, and direct sponsor category.</p>
            </div>
            
        </div>
    </div>

    <script type = module>

        import { updateLegend } from './updateLegend.js';

        //----D3FC version with WebGL ----
        d3.text("proposals_with_embeddings_full_updated.json").then(function(text) {
            const lines = text.trim().split('\n');

            const data = lines.map(line => {
                const { Title, 'Proposal PI' : ProposalPI, 'Proposal Direct Sponsor Category' : ProposalDirectSponsorCategory, 'HURON Authorized Amount' : HURONAuthorizedAmount, umap_x, umap_y } = JSON.parse(line);
                return { Title, 'Proposal PI': ProposalPI,  'Proposal Direct Sponsor Category' : ProposalDirectSponsorCategory ?? 'No Direct Sponsor', 'HURON Authorized Amount' : +HURONAuthorizedAmount ?? 0, umap_x: +umap_x, umap_y: +umap_y };
            });

            const getSponsorCategory = (d) => {
                const originalCategory = d['Proposal Direct Sponsor Category'];
                
                const otherCategories = [
                    'Foundation',
                    'Local Government',
                    'Foreign Government',
                    'Other State Governments',
                    'MC',
                    'No Direct Sponsor',
                    'Foreign Foundation',
                    'Foreign Higher Education Institutions',
                    'Virginia State Higher Education Institutions',
                    'Foreign Industry'
                ];
                
                if (otherCategories.includes(originalCategory)) {
                    return 'Other';
                }
                return originalCategory;
            };

            const x = d3.scaleLinear()
            const y = d3.scaleLinear()
            x.domain([0, 24]).nice();
            y.domain([-5,15]).nice();

            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            let colorMode = 'direct sponsor';
            const amountExtent = d3.extent(data, d => d['HURON Authorized Amount']); 
            const amountColorScale = d3.scaleSequentialLog(d3.interpolateGnBu)
                .domain([1, amountExtent[1]]);
            

            let fillColor;
            let scatter;
            let highlightedCategories = [];
            let showKDE = false;

            const toggleCategoryHighlight = (category) => {
                const index = highlightedCategories.indexOf(category);
                
                if (index === -1) {
                    highlightedCategories.push(category);
                } else {
                    highlightedCategories.splice(index, 1);
                }

                updateChart();
                updateLegend(data, colorMode, getSponsorCategory, colorScale, amountColorScale, amountExtent, highlightedCategories, toggleCategoryHighlight);
                render();
            };

            const tooltip = d3.select("body").append("div").attr("class", "tooltip");

            const informationOverlay = fc
                .seriesSvgPoint()
                .type(d3.symbolCircle)
                .size(30)
                .xScale(x)
                .yScale(y)
                .crossValue(d => d.umap_x)
                .mainValue(d => d.umap_y)
                .decorate(selection => {
                    selection.select('path')
                        .style('fill', 'transparent')
                        .style('stroke', 'transparent')
                        .style('stroke-width', 0.8);
                    selection
                        .on('mouseover', (event, d) => {
                            d3.select(event.currentTarget)
                                .select('path')
                                .style('stroke', 'black')
                                .style('stroke-opacity', 1);
                            tooltip.style("opacity", 0.83);

                            const scatterContainer = document.getElementById('my_scatter');
                            const rect = scatterContainer.getBoundingClientRect();
                            const scatterMidpoint = rect.left + rect.width / 2;
                            const tooltipWidth = 250; 
                            
                            let xPosition;
                            let yPosition = event.pageY - 20; 

                            if (event.pageX > scatterMidpoint) {
                                xPosition = event.pageX - tooltipWidth - 30;
                            } else {
                                xPosition = event.pageX + 15;
                            }
                            
                            tooltip.html(`<strong>Title</strong>: ${d.Title} <br> <strong>PI</strong>: ${d['Proposal PI']} <br> <strong>Direct Sponsor</strong>: ${d['Proposal Direct Sponsor Category']}`)
                                .style("left", xPosition + "px")
                                .style("top", yPosition + "px");
                        })
                        .on('mouseout', (event, d) => {
                            d3.select(event.currentTarget)
                                .select('path')
                                .style('stroke-opacity', 0);
                            tooltip.style("opacity", 0);
                        })
                        .on('click', (event, d) => {
                            d3.select("#info").html(`
                                <h2>Proposal Information</h2>
                                <p><strong>Title:</strong> ${d.Title}</p>
                                <p><strong>PI:</strong> ${d['Proposal PI']}</p>
                                <p><strong>Direct Sponsor Category:</strong> ${d['Proposal Direct Sponsor Category']}</p>
                                <p><strong>HURON Authorized Amount:</strong> $${d['HURON Authorized Amount']}</p>
                            `);
                        });
                });
            
            const contourSeries = fc.seriesSvgPoint()
                .xScale(x)
                .yScale(y)
                .crossValue(() => 0) // Dummy accessor, we are overriding this
                .mainValue(() => 0)  // Dummy accessor
                .decorate((selection, data) => { 
                    
                    // 'data' is the full 'contours' array from the .mapping
                    // 'selection' is the D3 selection of <g> elements (one for each contour)

                    if (!data || data.length === 0) {
                        return; // No contours to draw
                    }

                    // Create the path generator once
                    const pathGenerator = d3.geoPath();

                    // Update the color scale's domain using the full 'data' array
                    kdeColorScale.domain([0, d3.max(data, d => d.value)]);

                    // Select the <path> inside EACH <g>
                    selection.select('path')
                        // 'd' here is the single contour object for each path
                        .attr('d', d => pathGenerator(d)) 
                        .attr('fill', d => kdeColorScale(d.value))
                        .style('opacity', 0.5) // Semi-transparent
                        .style('stroke', 'none');
                });

            // --- 3. ADDED: Multi-series for the SVG layer ---
            const svgMultiSeries = fc.seriesSvgMulti()
                .series([contourSeries, informationOverlay]) // Contours first (bottom), then tooltips
                .mapping((data, index, series) => {
                    // 'data' is the bundled object from render()
                    switch (series) {
                        case informationOverlay:
                            return data.points; // Tooltips get point data
                        case contourSeries:
                            return data.contours; // KDE series gets contour data
                    }
                });

            const chart = fc
                .chartCartesian(x, y)
                .svgPlotArea(informationOverlay)
                .xDecorate(s => s.style('display', 'none')) 
                .yDecorate(s => s.style('display', 'none'));
            
            const updateChart = (displayData) => {
                fillColor = fc
                    .webglFillColor()
                    .value(d => {
                        if (colorMode === 'direct sponsor') {
                            const category = getSponsorCategory(d);
                            const color = d3.color(colorScale(category));
                            return [color.r / 255, color.g / 255, color.b / 255, 0.94]; 
                        }
                        else if (colorMode === 'awarded') {
                            console.log("awarded color mode");
                            return +d['HURON Authorized Amount'] > 0 ? [0.1, 0.6, 0.9, 1.0] : [0.6, 0.45, 0.3, 1.0]; 
                        }
                        else if (colorMode === 'amount') {
                            console.log("amount color mode");
                            const amount = +d['HURON Authorized Amount'];
                            if (amount <= 0) {
                                return [0.39, 0.39, 0.39, 0.5]; 
                            }
                            const logAmount = Math.log10(+d['HURON Authorized Amount']); 
                            const color = d3.color(amountColorScale(amount));
                            return [color.r / 255, color.g / 255, color.b / 255, 1.0];
                        }                   
                    })  
                .data(displayData);

                scatter = fc
                    .seriesWebglPoint()
                    .type(d3.symbolCircle)
                    .size(30)
                    .xScale(x)
                    .yScale(y)
                    .crossValue(d => d.umap_x)
                    .mainValue(d => d.umap_y)
                    .decorate(program => {
                        fillColor(program);
                        const context = program.context();
                        context.enable(context.BLEND);
                        context.blendFunc(context.SRC_ALPHA, context.ONE_MINUS_SRC_ALPHA);
                    })
                
                chart.webglPlotArea(scatter);
            }
                

            const render = () => {
                let displayData = data;
                if (colorMode === 'direct sponsor' && highlightedCategories.length > 0) {
                    displayData = data.filter(d => highlightedCategories.includes(getSponsorCategory(d)));
                }
                updateChart(displayData);

                d3.select('#my_scatter')
                    .datum(displayData)
                    .call(chart);
            };

            // Event listeners for controls
            d3.select('#color-mode-select').on('change', (event) => {
                colorMode = event.target.value;
                console.log("Color mode changed to:", colorMode);

                if (colorMode !== 'direct sponsor') {
                    highlightedCategories = [];
                }

                updateChart(data);
                updateLegend(data, colorMode, getSponsorCategory, colorScale, amountColorScale, amountExtent, highlightedCategories, toggleCategoryHighlight);
                render();
            });

            d3.select('#kde-toggle').on('change', function() {
                showKDE = this.checked;
                render();
            });

            const zoom = fc.zoom().on('zoom', render);

            d3.select('#my_scatter').call(zoom, x, y);
            
            // Initial rendering
            updateChart(data);
            updateLegend(data, colorMode, getSponsorCategory, colorScale, amountColorScale, amountExtent, highlightedCategories, toggleCategoryHighlight);
            render();
        });
    
    </script>

</body>